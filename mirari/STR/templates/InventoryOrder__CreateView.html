{% extends "generic/CreateView.html" %} 
{% load static %}
{% load i18n %}
{% load mirari_tags %}
{% load crispy_forms_tags %}
{% load humanize %}

{% block title %}ORDENES DE ENTREGA :: {{ G.ORGANIZATION.TITLE }}{% endblock title %}

{%block subheader%}
    <div class="kt-subheader__main">
        <h3 class="kt-subheader__title kt-subheader__title--separator">
            {%if not object%}
                <small>CREAR</small> 
                <strong style="font-size: 2rem;">ORDEN DE ENTREGA</strong>
            {%else%}
                <small>EDITAR</small> 
                <strong style="font-size: 2rem;">ORDEN DE ENTREGA</strong>
            {%endif%} 
        </h3>
        <span class="kt-subheader__separator kt-hidden"></span>
        <div class="kt-subheader__breadcrumbs">
            {%if redirect_model%}
                <span class="kt-subheader__breadcrumbs-separator"></span>
                <a href="{{redirect_model.url_list}}" class="kt-subheader__breadcrumbs-link">
                    Lista de {{ redirect_model|verbose_name_plural|upper }}
                </a>
            {%else%}
                <span class="kt-subheader__breadcrumbs-separator"></span>
                <a href="{{model.url_list}}" class="kt-subheader__breadcrumbs-link">
                    Lista de {{ model|verbose_name_plural|upper }}
                </a>
            {%endif%}
        </div>
    </div>
{%endblock subheader%}

{%block content%}
    <div class="row">
        <div class="col-xl-5">
            
        </div>
        <div class="col-xl-7">
            {% crispy form %}
        </div>
    </div>
{%endblock content%}


<script>
{%block data%}
    {{ block.super }}
    codebar: '' ,
    productList: [],
{%endblock data%}

{%block created%}
    $("#div_id_product").hide();
{%endblock created%}

{%block methods%}
    {{ block.super }}
    addProduct() {
        let id_product = document.querySelector('#id_product');
        if (id_product.value){
            Block();
            Ax('post', '/STR/api/InventoryApi/STR/Product/', {'productID':id_product.value})
            .then(function(json){
                if(json.data.product.name){
                    let resultado = self.productList.findIndex( product => {return product[0].id === json.data.product.id} );
                    if (resultado > -1){ 
                        let product = self.productList[resultado]
                        product[1] += 1 
                        self.productList.splice(resultado, 1)
                        self.productList.unshift(product)
                    }
                    else { self.productList.unshift([json.data.product, 1]) }
                }else{
                    Swal.fire('Intenta de nuevo','Producto no encontrado','error')
                }
            })
            .catch((error) => {
                Swal.fire('Intenta de nuevo','Ocurrio un error','error')
            }).finally(() => {
                UnBlock();
            });
        } else {
            Swal.fire('Intenta de nuevo','Elije un producto','error')
        }
    },
{%endblock methods%}

{%block filters%}
    {{block.super}}
    TotalProducts: ((productList) => {
        var total = 0
        var totalArray  = productList.map( product => {
            return product[1]
        })
        totalArray.forEach(totalProduct => total += totalProduct);
        return total
    }),
{%endblock filters%}
</script>
