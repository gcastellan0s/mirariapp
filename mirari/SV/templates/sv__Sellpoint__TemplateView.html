{%extends 'appwork/layout-without-navbar.html'%}
{%load static%}
{%load i18n%}

{%block styles%}
    <link rel="stylesheet" href="{%static 'appwork-html/vendor/libs/typeahead-js/typeahead.css'%}">
{%endblock styles%}

{%block css%}
    <style>{%include 'sv__Sellpoint__TemplateView.css'%}</style>
{%endblock%}

{%block content%}
    <div v-if="$route.path === '/sellpoint'">{%include 'Templete__sellpoint.pug'%}</div>
    <div v-else-if="$route.path === '/casher'">{%include 'Template__casher.pug'%}</div>
    <div v-else-if="$route.path === '/dashboard'">{%include 'Template__dashboard.pug'%}</div>
    <div v-else-if="$route.path === '/order'">{%include 'Template__order.pug'%}</div>
{%endblock%}

{%block js%}
    <script src="{%static 'appwork-html/vendor/libs/moment/moment.js'%}"></script>
    <script src="{%static 'appwork-html/vendor/libs/typeahead-js/typeahead.js'%}"></script>
{%endblock js%}

<script>
    {%block constants%}
        const router = new VueRouter({routes:[{ path:'/SV/sv/',component:{template:``}}]});
        const IVA = 0.16;
        const IEPS = 0.08;
        var PrivateSocket = null
    {%endblock constants%}

    {%block router%}router,{%endblock router%}

    {%block data%}
        ErrorText: null,
        Sellpoints: null,
        Sellpoint: null,
        Menus: null,
        Menu: {
            color: '#7b7b7b',
            id: 0,
        },
        ProductAttributes: null,
        Quantity: 'CANTIDAD',
        Price: 'PRECIO',
        Ticket: {
            products: [],
            key: null,
            format_time: null,
            format_date: null,
            barcode: '0',
            user: '{{request.user.id}}',
            username: null,
            cut: null,
            iva: 0,
            ieps: 0,
            total: 0,
            sellpoint: 0,
            client: {
                id: 0,  
                name: '',
                phone: '',
                rfc: '',
                email: '',
            },
            data: {
                datetimeOfDelivery: '',
                destination: '',
                notes: '',
            },
        },
        Tickets: [],
        Printers: [],
        Offers: [],
        ActivePrinter: {
            name: null,
        },
        LastTicketScan: null,
        ExtraMenu:{
            color: '#000',
            id: 0,
            name: '{{request.user.organization.name}}',
            nivel: 1,
            organization: {{request.user.organization.id}},
        },
        ClientName:'',
        Clients:[],
        Client: null,
    {%endblock data%}

    {%block mounted%}
        self.getStates(postFunctions=true)
    {%endblock mounted%}

    {%block methods%}
        initializePublicSocket: (() => {
            PublicSocket = io.connect('http://50.18.229.242:8002', {resource: 'PublicSocket/socket.io', 'force new connection': true});
            PublicSocket.emit('room', '{{request.user.organization.code}}');
            PublicSocket.on('Recibe_Event', (event, data) => {
                if (event == 'sendTicket') self.recibePrintTicket(data);
                if (event == 'printerConection') self.recibePrinterConection(data);
                if (event == 'scanTicket') self.recibeScanTicket(data);
                if (event == 'reloadSystem') self.recibeReloadSystem(data);
                if (event == 'getStates') self.recibeGetStates(data);
            });
        }),
        inititTypehead: (() => {
            var substringMatcher = function(strs) {
                return function findMatches(q, cb) {
                    var matches, substringRegex;
                    matches = [];
                    substrRegex = new RegExp(q, 'i');
                    $.each(strs, function(i, str) {
                        if (substrRegex.test(str.name)) {
                        matches.push(str.name);
                        }
                    });
                    cb(matches);
                };
            };
            $('#typeahead-input').typeahead({
                highlight: true,
                minLength: 1
            },
            {
                name: 'clients',
                source: substringMatcher(self.Clients),
            });
            $('#typeahead-input').on('typeahead:selected', function (e, datum) {
                self.ClientName = datum
            });
        }),
        selectMenu:((menu) => {self.Menu = menu}),
        addProduct: ((productattribute) => {
            if (self.Price == 'PRECIO') price = productattribute.price
            else price = self.Price
            if (self.Quantity == 'CANTIDAD') quantity = 1
            else quantity = parseInt(self.Quantity)
            productLine = self.Ticket.products.find(function(productLine) {
                return productLine.id == productattribute.id && productLine.price == productattribute.price;
            });
            if (!productLine){
                productLine = {
                    alias: productattribute.product.name,
                    productName: productattribute.product.name,
                    id: productattribute.id,
                    ieps: productattribute.ieps,
                    iva: productattribute.iva,
                    product: productattribute.product,
                    sellpoint: productattribute.sellpoint,
                    price: price,
                    quantity: quantity,
                    total: 0,
                    ivaTotal: 0,
                    iepsTotal: 0,
                    offers: [],
                }
                self.updateproductLineTotal(productLine)
                self.Ticket.products.unshift(productLine)
            }
            else {
                productLine.quantity += quantity
                self.updateproductLineTotal(productLine)
            }
            self.addOffers(productLine)
            self.makeTicketTotal()
            self.Quantity = 'CANTIDAD'
            self.Price = 'PRECIO'
            return true
        }),
        updateproductLineTotal: ((productLine) => {
            productLine.total = productLine.price * productLine.quantity
            if (productLine.iva) productLine.ivaTotal = (productLine.total / (IVA + 1) * IVA)
            if (productLine.ieps) productLine.iepsTotal = (productLine.total / (IEPS + 1) * IEPS)
            return productLine
        }),
        makeTicketTotal: (() => {
            self.Ticket.total = 0
            self.Ticket.iva = 0
            self.Ticket.ieps = 0
            self.Ticket.products.forEach(function(productLine){
                self.Ticket.total += productLine.total
                self.Ticket.iva += productLine.iva
                self.Ticket.ieps += productLine.ieps
                productLine.offers.forEach(function(offer){
                    if(offer.discountType == 'productPercent'){
                        self.Ticket.total -= (productLine.total*(offer.discountValue*.01))
                        self.Ticket.iva -= (productLine.iva*(offer.discountValue*.01))
                        self.Ticket.ieps -= (productLine.ieps*(offer.discountValue*.01))
                    }
                });
            });
        }),
        getBarCode: ((print=true, send=true, init=true) => {
            self.Ticket.key = self.randomChars(12, 'aplha_numbers')
            self.Ticket.format_time = String(moment().format('L'))
            self.Ticket.format_date = String(moment().format('LTS'))
            self.Ticket.status = 'COBRADO'
            if (self.Sellpoint.have_casher) self.Ticket.status = 'PENDIENTE'
            self.Ticket.sellpoint = self.Sellpoint.id
            self.Ticket.username = '{{request.user.visible_username}}'
            Ax('post', '{%url 'SV:Sellpoint__ApiView' 'SV' 'set_sellpoint' 'Sellpoint'%}?api=getBarCode', {
                ticket: JSON.stringify(self.Ticket),
            }, errorDialog=false)
            .then((json) => {
                self.Ticket.barcode = json.data.ticket.barcode
                self.Ticket.cut = json.data.ticket.cut
            }).catch((error) => {
                
            }).finally(() => { 
                if (print) self.printTicket(self.Ticket)
                if (send) self.sendTicket(self.Ticket)
                if (init) self.initTicket()
                if (self.includes(self.Sellpoint.cashers, {{request.user.id}})) self.$router.push('/casher')
            })
        }),
        getDataOrder: (() => {
            self.$router.push({path:'order', query:{orderMode:'finishOrder'}})
        }),
        getStates: ((postFunctions = false) => {
            //Block('Actualizando configuracion...')
            Ax('post', '{%url 'SV:Sellpoint__ApiView' 'SV' 'set_sellpoint' 'Sellpoint'%}?api=getStates')
            .then(function(json){
                self.Sellpoints = json.data.sellpoints
                self.Sellpoint = self.Sellpoints[0]
                self.Menus = json.data.menus
                self.ProductAttributes = json.data.productAttributes
                self.Offers = json.data.offers
                self.Tickets = json.data.tickets
                self.Clients = json.data.clients
                self.inititTypehead()
                if(postFunctions){
                    self.initializePublicSocket()
                    if(self.Menus) self.Menu = self.Menus[0]
                    if(!self.Sellpoint.printer) UnBlock()
                }
            }).catch((error) => {
                UnBlock()
            }).finally(() => {
                if (!postFunctions){
                    UnBlock()
                }
            });
        }),
        sendTicket: ((ticket) => {
            PublicSocket.emit('Send_Event', '{{request.user.organization.code}}', 'sendTicket', ticket)
        }),
        printTicket: ((ticket) => { 
            if (PrivateSocket){
                ticketFormat = []
                ticketFormat.push(["times",[self.Sellpoint.number_tickets]])
                ticketFormat.push(["set",["CT", "A", "bu", 2, 2]])
                ticketFormat.push(["text", '$' + self.$options.filters.formatPrice(String(self.Ticket.total))])
                ticketFormat.push(["set",["CT", "A", "bu", 1, 1]])
                if(self.Sellpoint.header_line_black_1) ticketFormat.push(["text", self.Sellpoint.header_line_black_1])
                if(self.Sellpoint.header_line_black_2) ticketFormat.push(["text", self.Sellpoint.header_line_black_2])
                ticketFormat.push(["set",["CT", "A", "bu", 1, 1]])
                if(self.Sellpoint.header_line_1) ticketFormat.push(["text", self.Sellpoint.header_line_1])
                if(self.Sellpoint.header_line_2) ticketFormat.push(["text", self.Sellpoint.header_line_2])
                ticketFormat.push(["text", self.Ticket.format_date + ' ' + self.Ticket.format_time])
                ticketFormat.push(["text", '------------------------------------------'])
                self.Ticket.products.forEach(function(product){
                    ticketFormat.push(["set",["LT", "A", "bu", 1, 1]])
                    ticketFormat.push(["text", String(product.quantity) + ' ' + product.productName + ' ' + '$' + self.$options.filters.formatPrice(String(product.total)) ])
                    product.offers.forEach(function(offer){
                        ticketFormat.push(["set",["RT", "A", "bu", 1, 1]])
                        ticketFormat.push(["text", offer.name + ' -' + offer.discountValue + '%'])
                    });
                });
                ticketFormat.push(["set",["RT", "A", "bu", 1, 1]])
                ticketFormat.push(["text", 'IVA: $' + self.$options.filters.formatPrice(String(self.Ticket.iva))])
                ticketFormat.push(["set",["RT", "A", "bu", 1, 1]])
                ticketFormat.push(["text", ' IEPS: $' + self.$options.filters.formatPrice(String(self.Ticket.ieps))])
                ticketFormat.push(["set",["RT", "A", "bu", 1, 1]])
                ticketFormat.push(["text", ' TOTAL: $' + self.$options.filters.formatPrice(String(self.Ticket.total))])
                ticketFormat.push(["set",["CT", "A", "bu", 1, 1]])
                ticketFormat.push(["text", self.Ticket.barcode + ' :: ' + self.Ticket.key])
                ticketFormat.push(["qr",self.Ticket.key])
                PrivateSocket.emit('Send_Event','{{request.user.organization.code}}','Print', ticketFormat)
            }
        }),
        initTicket: (() => {
            self.Ticket = {
                products: [],
                key: null,
                format_time: null,
                format_date: null,
                barcode: '0',
                user: '{{request.user.id}}',
                username: null,
                cut: null,
                iva: 0,
                ieps: 0,
                total: 0,
                proccessing: false,
                sellpoint: 0,
                client: {
                    id: 0,  
                    name: '',
                    phone: '',
                    rfc: '',
                    email: '',
                },
                data: {
                    datetimeOfDelivery: '',
                    destination: '',
                    notes: '',
                },
            }
        }),
        makeCut: (() => {
            Block(text="Haciendo corte...");
            Ax('post', '{%url 'SV:Sellpoint__ApiView' 'SV' 'set_sellpoint' 'Sellpoint'%}?api=makeCut', {
                sellpoint: JSON.stringify(self.Sellpoint),
            }, errorDialog=false)
            .then((json) => {
                if (PrivateSocket){
                    ticketFormat = []
                    ticketFormat.push(["set",["center", "A", "B", 2, 2]])
                    ticketFormat.push(["text", '\n'])
                    ticketFormat.push(["text", 'TOTAL: ' + json.data.cut.propertyGetTotalMoney + '\n'])
                    ticketFormat.push(["set",["center", "A", "B", 1, 1]])
                    ticketFormat.push(["text", 'FOLIO: ' + String(json.data.cut.serial) + '\n'])
                    ticketFormat.push(["text", moment(json.data.cut.final_time).format('MMMM D, h:mm:ss a') + '\n'])
                    ticketFormat.push(["text", self.Sellpoint.name + '\n'])
                    ticketFormat.push(["text", '------------------------------------------\n'])
                    ticketFormat.push(["set",["center", "A", "B", 1, 1]])
                    if(self.Sellpoint.header_line_black_1) ticketFormat.push(["text", '\n'])
                    if(self.Sellpoint.header_line_black_1) ticketFormat.push(["text", self.Sellpoint.header_line_black_1 + '\n'])
                    if(self.Sellpoint.header_line_black_2) ticketFormat.push(["text", self.Sellpoint.header_line_black_2 + '\n'])
                    ticketFormat.push(["set",["center", "A", "", 1, 1]])
                    if(self.Sellpoint.header_line_1) ticketFormat.push(["text", self.Sellpoint.header_line_1 + '\n'])
                    if(self.Sellpoint.header_line_2) ticketFormat.push(["text", self.Sellpoint.header_line_2 + '\n'])
                    if(self.Sellpoint.footer_line_1) ticketFormat.push(["text", self.Sellpoint.footer_line_1 + '\n'])
                    ticketFormat.push(["text", 'No. tickets faltantes: ' + json.data.cut.propertyGetLenFaltante + '\n'])
                    ticketFormat.push(["text", 'No. de clientes: ' + json.data.cut.propertyGetLenTickets + '\n'])
                    ticketFormat.push(["text", '1er ticket: ' + moment(json.data.cut.initial_time).format('MMMM D, h:mm:ss a') + '\n'])
                    ticketFormat.push(["text", '------------------------------------------\n'])
                    json.data.cut.products.forEach(function(product){
                        ticketFormat.push(["set",["left", "A", "", 1, 1]])
                        ticketFormat.push(["text", String(product.quantity) + ' '])
                        ticketFormat.push(["text", product.productName + ' '])
                        ticketFormat.push(["text", 'de ' + product.getPrice])
                        ticketFormat.push(["text", ' --> ' + product.getTotalMoney + '\n'])
                        if (product.offers){
                            product.offers.forEach(function(offer){
                                ticketFormat.push(["set",["right", "A", "", 1, 1]])
                                ticketFormat.push(["text", ' -' + offer.name + '\n'])
                            });
                        }
                    });
                    ticketFormat.push(["text", '------------------------------------------\n'])
                    ticketFormat.push(["set",["right", "A", "B", 1, 1]])
                    ticketFormat.push(["text", 'IVA: ' + json.data.cut.propertyGetIvaMoney + '\n'])
                    ticketFormat.push(["set",["right", "A", "B", 1, 1]])
                    ticketFormat.push(["text", 'IEPS: ' + json.data.cut.propertyGetIepsMoney + '\n'])
                    ticketFormat.push(["set",["right", "A", "B", 1, 1]])
                    ticketFormat.push(["text", 'FALTANTE: ' + json.data.cut.propertyGetFaltanteMoney + '\n'])
                    ticketFormat.push(["set",["right", "A", "B", 1, 1]])
                    ticketFormat.push(["text", 'TOTAL: ' + json.data.cut.propertyGetTotalMoney + '\n'])
                    ticketFormat.push(["cut"])
                    PrivateSocket.emit('Send_Event','{{request.user.organization.code}}','Print', ticketFormat)
                }
            }).catch((error) => {
                console.log(error)
            }).finally(() => {
                UnBlock()
                self.emmitGetStates()
            });
        }),
        addOffers: ((productLine) => {
            self.Offers.filter(function(offer){return offer.mySellpoints.includes(self.Sellpoint.id)&&offer.myConditionProducts.includes(productLine.product.id)})
            .forEach(function(element) {
                productLinesConditionProducts = self.Ticket.products.filter(function(productLine){
                    return element.myConditionProducts.includes(productLine.product.id)
                });
                productLinesDiscountProducts = self.Ticket.products.filter(function(productLine){
                    return element.myDiscountProducts.includes(productLine.product.id)
                });
                if(element.conditionType == 'productQuantity') self.offerProductQuantity(element, productLinesConditionProducts, productLinesDiscountProducts)
            });
        }),
        offerProductQuantity: ((offer, productLinesConditionProducts, productLinesDiscountProducts) => {
            ProductQuantity = 0
            apply = false
            productLinesConditionProducts.forEach(function(productLine){
                ProductQuantity += productLine.quantity
            });
            if(ProductQuantity >= offer.conditionValue) apply = true
            self.applyOrRemoveOffer(offer, productLinesConditionProducts, productLinesDiscountProducts, apply)
        }),
        applyOrRemoveOffer: ((offer, productLinesConditionProducts, productLinesDiscountProducts, apply) => {
            productLinesDiscountProducts.forEach(function(productLine){
                if (apply == false){if(productLine.offers.length) productLine.offers = productLine.offers.filter(item => item !== offer)}
                else{
                    if(productLine.offers.length){if(!(productLine.offers.includes(offer))){productLine.offers.push(offer)}}
                    else productLine.offers.push(offer)
                }
            });
        }),
        getClient: ((ClientName) => {
            console.log(ClientName)
            Ax('post', '{%url 'SV:Sellpoint__ApiView' 'SV' 'set_sellpoint' 'Sellpoint'%}?api=getClient', {ClientName: ClientName})
            .then(function(json){
                console.log(json)
                self.Client = json.data.client
            }).catch((error) => {
            }).finally(() => {
            });
        }),
        /////SYSTEM
        redirect: ((url) => {
            window.location.replace(url);
        }),
        reloadSystem: ((text='Espere un momento...') => {
            Block(text)
            location.reload();
        }),
        reloadData: ((text='Espere un momento...') => {
            
        }),
        /////SOCKETIO
        recibePrinterConection: ((data) => {
            if(self.Sellpoint.printer == data.name){
                if (data.name != self.ActivePrinter.name){
                    self.ActivePrinter = data
                    PrivateSocket = io.connect(self.ActivePrinter.url, {resource: 'PrivateSocket/socket.io', 'force new connection': true});
                    UnBlock()
                }
            }
        }),
        recibePrintTicket: ((data) => {
            //if(data.sellpoint.vendors.includes({{request.user.id}})) 
            self.Tickets.unshift(data)
            console.log(data)
        }),
        recibeScanTicket: ((data) => {
            updateTicket = self.Tickets.find(function(ticket) {
                return ticket.key == data.key;
            });
            if (updateTicket){
                updateTicket.status = data.status
                updateTicket.barcode = data.barcode
                updateTicket.cut = data.cut
                self.LastTicketScan = data.barcode
            }
        }),
        recibeReloadSystem: ((data) => {
            self.reloadSystem()
        }),
        recibeGetStates: ((data) => {
            self.getStates()
        }),
        emmitReloadSystem: (() => {
            PublicSocket.emit('Send_Event', '{{request.user.organization.code}}', 'reloadSystem', {})
        }),
        emmitGetStates: (() => {
            PublicSocket.emit('Send_Event', '{{request.user.organization.code}}', 'getStates', {})
        }),
        /////PLUGINS
        keyboard: ((value) => {
            if (self.Quantity == 'CANTIDAD') self.Quantity = ''
            if (value == '.'){
                if (self.Quantity.indexOf(".") !=-1) return 0
            } 
            if (value == '<'){
                self.Quantity = self.Quantity.substring(0, self.Quantity.length - 1)
                if (self.Quantity.length == 0) self.Quantity = 'CANTIDAD'
                return 0
            }
            self.Quantity += value
        }),
        randomChars: function(length, type="aplha_numbers") { 
            text = ""
            aplha_numbers = "abcdefghijklmnopqrstuvwxyz0123456789";
            numbers = "0123456789";
            if (type=='letters_numbers') possible = letters_numbers
            else if (type=='aplha_numbers') possible = aplha_numbers
            else possible = numbers
            for (var i = 0; i < length; i++) text += possible.charAt(Math.floor(Math.random() * possible.length))
            return text
        },
        includes: ((object, element) => {
            if (!object) return false
            return object.includes(element)
        }),
        checkClient: ((ClientName) => {
            checkclient = self.Clients.find(function(client) {
                return client.name == ClientName
            });
            if(checkclient) return true
            return false
        }),
    {%endblock methods%}

    {%block filters%}
        firstNameMenu: ((value) => {
            if (!value) return ''
            return value.toString().charAt(0).toUpperCase()
        }),
        lastNameMenu: ((value) => {
            if (!value) return ''
            return value.toString().slice(1)
        }),
        formatPrice: ((value) => {
            let val = (value/1).toFixed(2)
            return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")
        }),
        FormatTDate: ((value) => {
            moment.locale('es');
            return moment(value).format('MMMM D, h:mm a')
        }),
        padStart: ((value) => {
            return value.padStart(13, "1000000000000")
        }),
    {%endblock filters%}

    {%block watch%}
        ClientName: function (newData, oldData) {
            if(self.checkClient(newData)) self.getClient(newData)
        }
    {%endblock watch%}
</script>