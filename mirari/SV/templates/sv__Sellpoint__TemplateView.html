{%extends 'appwork/layout-without-navbar.html'%}
{%load static%}
{%load i18n%}

{%block styles%}
    <link rel="stylesheet" href="{%static 'appwork-html/vendor/libs/bootstrap-material-datetimepicker/bootstrap-material-datetimepicker.css'%}">
{%endblock styles%}

{%block css%}
    <style>{%include 'sv__Sellpoint__TemplateView.css'%}</style>
{%endblock%}

{%block content%}
    <div v-if="$route.path === '/sellpoint'">{%include 'Templete__sellpoint.pug'%}</div>
    <div v-else-if="$route.path === '/casher'">{%include 'Template__casher.pug'%}</div>
    <div v-else-if="$route.path === '/dashboard'">{%include 'Template__dashboard.pug'%}</div>
    <div v-else-if="$route.path === '/order'">{%include 'Template__order.pug'%}</div>
    <div v-else-if="$route.path === '/client'">{%include 'Template__client.pug'%}</div>
{%endblock%}

{%block js%}
    <script src="{%static 'appwork-html/vendor/libs/moment/moment.js'%}"></script>
    <script src="{%static 'appwork-html/vendor/libs/bootstrap-material-datetimepicker/bootstrap-material-datetimepicker.js'%}"></script>
{%endblock js%}

<script>
    {%block constants%}
        const router = new VueRouter({routes:[{ path:'/SV/sv/',component:{template:``}}]});
        const IVA = 0.16;
        const IEPS = 0.08;
        var PrivateSocket = null
    {%endblock constants%}

    {%block plugins%}
    {%endblock plugins%}

    {%block router%}router,{%endblock router%}

    {%block data%}
        ErrorText: null,
        Sellpoints: null,
        Sellpoint: null,
        Menus: null,
        Menu: {
            color: '#7b7b7b',
            id: 0,
        },
        ProductAttributes: null,
        Quantity: 'CANTIDAD',
        Price: 'PRECIO',
        Ticket: {
            products: [],
            key: null,
            format_time: null,
            format_date: null,
            barcode: '0',
            user: '{{request.user.id}}',
            username: null,
            cut: null,
            iva: 0,
            ieps: 0,
            total: 0,
            sellpoint: {},
            onAccount: 0,
            datetimeOfDelivery: null,
            destination: null,
            notes: null,
            clientID: 0,
            clientName: null,
            email: null,
            phone: null,
            rfc: null,
            ticketType: 'VENTA',
        },
        Tickets: [],
        Printers: [],
        Offers: [],
        ActivePrinter: {
            name: null,
        },
        LastTicketScan: null,
        ExtraMenu:{
            color: '#000',
            id: 0,
            name: '{{request.user.organization.name}}',
            nivel: 1,
            organization: {{request.user.organization.id}},
        },
        Clients:[],
        Client: {
            id: 0,
            name: '',
            ide: '',
            clientProfile:{
                code: null,
            }
        },
    {%endblock data%}

    {%block mounted%}
        self.getStates(postFunctions=true)
        setInterval(function(){
            self.getStates(postFunctions=false)
        }, 1000000);
    {%endblock mounted%}

    {%block methods%}
        getStates: ((postFunctions = false) => {
            Block('Actualizando configuracion...')
            Ax('post', '{%url 'SV:Sellpoint__ApiView' 'SV' 'set_sellpoint' 'Sellpoint'%}?api=getStates', errorDialog=false).then(function(json){
                self.Sellpoints = json.data.sellpoints
                //self.Sellpoints.forEach(function(element){if(element.orders.includes({{request.user.id}})){self.Sellpoint=element;return 0}})
                //if(!self.Sellpoint){self.Sellpoints.forEach(function(element){if(element.cashers.includes({{request.user.id}})){self.Sellpoint=element;return 0}})}
                //if(!self.Sellpoint){self.Sellpoint = self.Sellpoints[0]}
                self.Sellpoint = self.Sellpoints[0]
                if({{request.user.id}}==327) self.Sellpoint = self.Sellpoints[1]
                self.Menus = json.data.menus
                self.ProductAttributes = json.data.productAttributes
                self.Offers = json.data.offers
                self.Tickets = json.data.tickets
                if(postFunctions){
                    self.initializePublicSocket()
                    if(self.Menus) self.Menu = self.Menus[0]
                    if(!self.Sellpoint.printer) UnBlock()
                }
            }).catch((error) => { 
                UnBlock();
            }).finally(() => {
                if (!postFunctions){
                    UnBlock()
                }
            });
        }),
        initializePublicSocket: (() => {
            PublicSocket = io.connect('http://50.18.229.242:8002', {resource: 'PublicSocket/socket.io', 'force new connection': true});
            PublicSocket.emit('room', '{{request.user.organization.code}}');
            PublicSocket.on('Recibe_Event', (event, data) => {
                if (event == 'getStates') self.recibeGetStates(data);
                if (event == 'printerConection') self.recibePrinterConection(data);
                if (event == 'sendTicket') self.recibePrintTicket(data);
                if (event == 'scanTicket') self.recibeScanTicket(data);
                if (event == 'reloadSystem') self.recibeReloadSystem(data);
            });   
        }),
        addProduct: ((productattribute) => {
            if (self.Price == 'PRECIO') price = productattribute.price
            else price = self.Price
            if (self.Quantity == 'CANTIDAD') quantity = 1
            else quantity = parseInt(self.Quantity)
            productLine = self.Ticket.products.find(function(productLine) {
                return productLine.id == productattribute.id && productLine.price == productattribute.price;
            });
            if (!productLine){
                productLine = {
                    alias: productattribute.product.name,
                    productName: productattribute.product.name,
                    id: productattribute.id,
                    ieps: productattribute.ieps,
                    iva: productattribute.iva,
                    product: productattribute.product,
                    sellpoint: productattribute.sellpoint,
                    price: price,
                    quantity: quantity,
                    total: 0,
                    ivaTotal: 0,
                    iepsTotal: 0,
                    offers: [],
                }
                self.updateproductLineTotal(productLine)
                self.Ticket.products.unshift(productLine)
            }
            else {
                productLine.quantity += quantity
                self.updateproductLineTotal(productLine)
            }
            self.addOffers(productLine)
            self.makeTicketTotal()
            self.Quantity = 'CANTIDAD'
            self.Price = 'PRECIO'
            return true
        }),
        addOffers: ((productLine) => {
            self.Offers.filter(function(offer){return offer.mySellpoints.includes(self.Sellpoint.id)&&offer.myConditionProducts.includes(productLine.product.id)})
            .forEach(function(element){
                apply = true
                if(element.clients.length>0){if(!element.clients.includes(self.Client.id))apply = false}
                if(apply){
                    productLinesConditionProducts = self.Ticket.products.filter(function(productLine){
                        return element.myConditionProducts.includes(productLine.product.id)
                    });
                    productLinesDiscountProducts = self.Ticket.products.filter(function(productLine){
                        return element.myDiscountProducts.includes(productLine.product.id)
                    });
                    if(element.conditionType == 'productQuantity') self.offerProductQuantity(element, productLinesConditionProducts, productLinesDiscountProducts)
                }
            });
        }),
        offerProductQuantity: ((offer, productLinesConditionProducts, productLinesDiscountProducts) => {
            ProductQuantity = 0
            apply = false
            productLinesConditionProducts.forEach(function(productLine){
                ProductQuantity += productLine.quantity
            });
            if(ProductQuantity >= offer.conditionValue) apply = true
            self.applyOrRemoveOffer(offer, productLinesConditionProducts, productLinesDiscountProducts, apply)
        }),
        applyOrRemoveOffer: ((offer, productLinesConditionProducts, prodproccessinguctLinesDiscountProducts, apply) => {
            productLinesDiscountProducts.forEach(function(productLine){
                if (apply == false){if(productLine.offers.length) productLine.offers = productLine.offers.filter(item => item !== offer)}
                else{
                    if(productLine.offers.length){if(!(productLine.offers.includes(offer))){productLine.offers.push(offer)}}
                    else productLine.offers.push(offer)
                }
            });
        }),
        makeTicketTotal: (() => { ////// SE APLICAN LAS OFERTAS /////
            self.Ticket.total = 0
            self.Ticket.iva = 0
            self.Ticket.ieps = 0
            self.Ticket.products.forEach(function(productLine){
                self.Ticket.total += productLine.total
                self.Ticket.iva += productLine.iva
                self.Ticket.ieps += productLine.ieps
                productLine.offers.forEach(function(offer){
                    if(offer.discountType == 'productValue'){
                        discountValue = 100 - (offer.discountValue * 100 / productLine.price)
                        self.Ticket.total -= (productLine.total*(discountValue*.01))
                        self.Ticket.iva -= (productLine.iva*(discountValue*.01))
                        self.Ticket.ieps -= (productLine.ieps*(discountValue*.01))
                        productLine.offerprice = productLine.price - (productLine.price*(discountValue*.01))
                    }
                    else if(offer.discountType == 'productPercent'){
                        self.Ticket.total -= (productLine.total*(offer.discountValue*.01))
                        self.Ticket.iva -= (productLine.iva*(offer.discountValue*.01))
                        self.Ticket.ieps -= (productLine.ieps*(offer.discountValue*.01))
                        productLine.offerprice = productLine.price - (productLine.price*(offer.discountValue*.01))
                    }
                });
            });
        }),
        updateproductLineTotal: ((productLine) => {
            productLine.total = productLine.price * productLine.quantity
            if (productLine.iva) productLine.ivaTotal = (productLine.total / (IVA + 1) * IVA)
            if (productLine.ieps) productLine.iepsTotal = (productLine.total / (IEPS + 1) * IEPS)
            return productLine
        }),
        getBarCode:((print=true, send=true, init=true) => {
            Block('Generando...')
            self.Ticket.key = self.randomChars(12, 'aplha_numbers')
            self.Ticket.format_time = String(moment().format('LTS'))
            self.Ticket.format_date = String(moment().format('L'))
            self.Ticket.status = 'COBRADO'
            if (self.Sellpoint.have_casher) self.Ticket.status = 'PENDIENTE'
            self.Ticket.sellpoint.id = self.Sellpoint.id
            self.Ticket.sellpoint.name = self.Sellpoint.name
            self.Ticket.sellpoint.color = self.Sellpoint.color
            self.Ticket.username = '{{request.user.visible_username}}'
            Ax('post', '{%url 'SV:Sellpoint__ApiView' 'SV' 'set_sellpoint' 'Sellpoint'%}?api=getBarCode',{ticket: JSON.stringify(self.Ticket)},errorDialog=false)
            .then((json) => {
                Block('Imprimiendo...')
                self.Ticket.barcode = json.data.ticket.barcode
                self.Ticket.cut = json.data.ticket.cut
            }).catch((error) => { Block('Imprimiendo sin internet...')
            }).finally(() => { 
                if (print) {
                    self.printTicket(self.Ticket)
                    //times = 2
                    //'.'.repeat(times).split('').forEach(x => {
                        //setTimeout(function() {
//                            
                        //}, 2000);
                    //});
                }
                if (send) {
                    if(self.Ticket.ticketType=='VENTA' || self.Ticket.ticketType=='PAGO' ) self.emmitSendTicket(self.Ticket)
                }
                if (init) self.initTicket()
                if (self.includes(self.Sellpoint.orders, {{request.user.id}})){
                    self.resetOrder()
                    self.$router.push({path:'order', query:{orderMode:'selectOrder'}})
                }
                else if (self.includes(self.Sellpoint.cashers, {{request.user.id}})) self.$router.push('/casher')
                UnBlock();
            });
        }),
        printTicket: ((ticket) => { 
            if (PrivateSocket){
                ticketFormat = []
                ticketFormat.push(["times",[self.Sellpoint.number_tickets]])
                ticketFormat.push(["set",["CT", "A", "bu", 2, 2]])
                if (self.Ticket.onAccount){ticketFormat.push(["text", '$' + self.$options.filters.formatPrice(String(self.Ticket.onAccount))])}
                else {ticketFormat.push(["text", '$' + self.$options.filters.formatPrice(String(self.Ticket.total))])}
                ticketFormat.push(["set",["CT", "A", "bu", 1, 1]])
                if(self.Sellpoint.header_line_black_1) ticketFormat.push(["text", self.Sellpoint.header_line_black_1])
                if(self.Sellpoint.header_line_black_2) ticketFormat.push(["text", self.Sellpoint.header_line_black_2])
                ticketFormat.push(["set",["CT", "A", "bu", 1, 1]])
                if(self.Sellpoint.header_line_1) ticketFormat.push(["text", self.Sellpoint.header_line_1])
                if(self.Sellpoint.header_line_2) ticketFormat.push(["text", self.Sellpoint.header_line_2])
                ticketFormat.push(["text", self.Ticket.format_date + ' ' + self.Ticket.format_time])
                if (self.Ticket.clientID) ticketFormat.push(["text", '------------------------------------------'])
                if (self.Ticket.clientID) ticketFormat.push(["text", 'ID Cliente: ' + self.Ticket.clientID])
                if (self.Ticket.clientName) ticketFormat.push(["text", 'Nombre: ' + self.Ticket.clientName])
                if (self.Ticket.email) ticketFormat.push(["text", 'Email: ' + self.Ticket.email])
                if (self.Ticket.phone) ticketFormat.push(["text", 'Teléfono: ' + self.Ticket.phone])
                if (self.Ticket.rfc) ticketFormat.push(["text", 'RFC: ' + self.Ticket.rfc])
                if (self.Ticket.datetimeOfDelivery) ticketFormat.push(["text", 'Fecha de entrega: ' + self.Ticket.datetimeOfDelivery])
                if (self.Ticket.destination) ticketFormat.push(["text", 'Destino: ' + self.Ticket.destination])
                if (self.Ticket.notes) ticketFormat.push(["text", 'Notas: ' + self.Ticket.notes])
                ticketFormat.push(["text", '------------------------------------------'])
                self.Ticket.products.forEach(function(product){
                    ticketFormat.push(["set",["LT", "A", "bu", 1, 1]])
                    ticketFormat.push(["text", String(product.quantity) + ' ' + product.productName + ' ' + '$' + self.$options.filters.formatPrice(String(product.total))])
                    product.offers.forEach(function(offer){
                        ticketFormat.push(["set",["RT", "A", "bu", 1, 1]])
                        ticketFormat.push(["text", offer.name + ' -' + offer.discountValue + '%'])
                    });
                });
                ticketFormat.push(["set",["RT", "A", "bu", 1, 1]])
                ticketFormat.push(["text", 'IVA: $' + self.$options.filters.formatPrice(String(self.Ticket.iva))])
                ticketFormat.push(["text", 'IEPS: $' + self.$options.filters.formatPrice(String(self.Ticket.ieps))])
                if (self.Ticket.onAccount){ticketFormat.push(["text", 'A CUENTA: $' + self.$options.filters.formatPrice(String(self.Ticket.onAccount))])}
                ticketFormat.push(["text", 'TOTAL: $' + self.$options.filters.formatPrice(String(self.Ticket.total))])
                ticketFormat.push(["set",["CT", "A", "bu", 1, 1]])
                ticketFormat.push(["text", self.Ticket.barcode + ' :: ' + self.Ticket.key])
                ticketFormat.push(["qr",self.Ticket.key])
                PrivateSocket.emit('Send_Event','{{request.user.organization.code}}','Print', ticketFormat)
            }
        }),
        initTicket: (() => {
            self.Ticket = {
                products: [],
                key: null,
                format_time: null,
                format_date: null,
                barcode: '0',
                user: '{{request.user.id}}',
                username: null,
                cut: null,
                iva: 0,
                ieps: 0,
                total: 0,
                sellpoint: {},
                onAccount: 0,
                datetimeOfDelivery: null,
                destination: null,
                notes: null,
                clientID: 0,
                clientName: null,
                email: null,
                phone: null,
                rfc: null,
                ticketType: 'VENTA',
            }
        }),
        makeCut: (() => {
            Block(text="Haciendo corte...");
            Ax('post', '{%url 'SV:Sellpoint__ApiView' 'SV' 'set_sellpoint' 'Sellpoint'%}?api=makeCut', {
                sellpoint: JSON.stringify(self.Sellpoint),
            })
            .then((json) => {
                console.log(json)
                if (PrivateSocket){
                    ticketFormat = []
                    ticketFormat.push(["times",[1]])
                    ticketFormat.push(["set",["CT", "A", "bu", 2, 2]])
                    ticketFormat.push(["text", 'TOTAL: ' + json.data.cut.TotalDetail['all'][1]])
                    ticketFormat.push(["set",["CT", "A", "bu", 1, 1]])
                    ticketFormat.push(["text", 'FOLIO: ' + String(json.data.cut.serial)])
                    ticketFormat.push(["text", moment(json.data.cut.final_time).format('MMMM D, h:mm:ss a')])
                    ticketFormat.push(["text", self.Sellpoint.name])
                    ticketFormat.push(["text", '------------------------------------------'])
                    ticketFormat.push(["set",["CT", "A", "bu", 1, 1]])
                    if(self.Sellpoint.header_line_black_1) ticketFormat.push(["text", self.Sellpoint.header_line_black_1])
                    if(self.Sellpoint.header_line_black_2) ticketFormat.push(["text", self.Sellpoint.header_line_black_2])
                    ticketFormat.push(["set",["CT", "A", "", 1, 1]])
                    if(self.Sellpoint.header_line_1) ticketFormat.push(["text", self.Sellpoint.header_line_1])
                    if(self.Sellpoint.header_line_2) ticketFormat.push(["text", self.Sellpoint.header_line_2])
                    if(self.Sellpoint.footer_line_1) ticketFormat.push(["text", self.Sellpoint.footer_line_1])
                    ticketFormat.push(["text", 'No. tickets faltantes: ' + json.data.cut.getLenFaltante])
                    ticketFormat.push(["text", 'No. de clientes: ' + json.data.cut.getLenFaltante])
                    ticketFormat.push(["text", '1er ticket: ' + moment(json.data.cut.initial_time).format('MMMM D, h:mm:ss a')])
                    ticketFormat.push(["text", '------------------------------------------'])
                    json.data.cut.ProductsDetail['all'].forEach(function(product){
                        ticketFormat.push(["set",["LT", "bu", "", 1, 1]])
                        ticketFormat.push(["text", '-' + String(product.quantity) + ' ' + product.productName + ' de ' + product.getPrice + ' --> ' + product.getTotalMoney])
                    });
                    ticketFormat.push(["text", '------------------------------------------'])
                    ticketFormat.push(["set",["RT", "A", "bu", 1, 1]])
                    ticketFormat.push(["text", 'IVA: ' + json.data.cut.IvaDetail['all'][1]])
                    ticketFormat.push(["set",["RT", "A", "bu", 1, 1]])
                    ticketFormat.push(["text", 'IEPS: ' + json.data.cut.IepsDetail['all'][1]])
                    ticketFormat.push(["set",["RT", "A", "bu", 1, 1]])
                    ticketFormat.push(["text", 'FALTANTE: ' + json.data.cut.TotalDetail['all'][3]])
                    ticketFormat.push(["set",["RT", "A", "bu", 1, 1]])
                    ticketFormat.push(["text", 'TOTAL: ' + json.data.cut.TotalDetail['all'][1]])
                    ticketFormat.push(["set",["CT", "A", "bu", 1, 1]])
                    ticketFormat.push(["cut"])
                    PrivateSocket.emit('Send_Event','{{request.user.organization.code}}','Print', ticketFormat)
                }
            }).catch((error) => { console.log(error)
            }).finally(() => {
                UnBlock()
                self.emmitGetStates()
            });
        }),
        getClient: ((client) => {
            if(client.id){
                Ax('post', '{%url 'SV:Sellpoint__ApiView' 'SV' 'set_sellpoint' 'Sellpoint'%}?api=getClient', client)
                .then(function(json){
                    self.Client = json.data.client
                }).catch((error) => {});
            }
            else{
                self.Client = client
            }
            self.initTicket()
            self.$router.push({path:'order', query:{orderMode:'selectOrder'}})
        }),
        resetOrder: ((resetTicket=false)=>{
            self.Clients = []
            self.Client = {
                id: 0,
                name: '',
                ide: '',
                clientProfile:{
                    code: null,
                },
            }
            if(resetTicket) self.initTicket()
        }),
        getDataOrder: (() => {
            if(self.Client.uid){self.Ticket.clientID = self.Client.uid}
            else{self.Ticket.clientID = self.randomChars(6,'aplha_numbers')}
            if(self.Client.clientProfile.code == 'PUBLICO GENERAL' || self.Client.clientProfile.code == null) self.Ticket.onAccount = self.Ticket.total
            self.Ticket.clientName = self.Client.name
            self.Ticket.email = self.Client.email
            self.Ticket.phone = self.Client.phone
            self.Ticket.rfc = self.Client.rfc
            self.$router.push({path:'order',query:{orderMode:'finishOrder'}})
        }),
        /////SYSTEM
        reloadSystem: ((text='Espere un momento...') => {
            Block(text)
            location.reload();
        }),
        {%include 'Template__socketio.js'%}
        /////PLUGINS
        emmitReloadSystem: (() => {
            PublicSocket.emit('Send_Event', '{{request.user.organization.code}}', 'reloadSystem', {})
        }),
        emmitGetStates: (() => {
            PublicSocket.emit('Send_Event', '{{request.user.organization.code}}', 'getStates', {})
        }),
        emmitSendTicket: ((ticket) => {
            PublicSocket.emit('Send_Event', '{{request.user.organization.code}}', 'sendTicket', ticket)
        }),
        keyboard: ((value) => {
            if (self.Quantity == 'CANTIDAD') self.Quantity = ''
            if (value == '.'){
                if (self.Quantity.indexOf(".") !=-1) return 0
            } 
            if (value == '<'){
                self.Quantity = self.Quantity.substring(0, self.Quantity.length - 1)
                if (self.Quantity.length == 0) self.Quantity = 'CANTIDAD'
                return 0
            }
            self.Quantity += value
        }),
        randomChars: function(length, type="aplha_numbers") { 
            text = ""
            aplha_numbers = "abcdefghijklmnopqrstuvwxyz0123456789";
            numbers = "0123456789";
            if (type=='letters_numbers') possible = letters_numbers
            else if (type=='aplha_numbers') possible = aplha_numbers
            else possible = numbers
            for (var i = 0; i < length; i++) text += possible.charAt(Math.floor(Math.random() * possible.length))
            return text
        },
        includes: ((object, element) => {
            if (!object) return false
            return object.includes(element)
        }),
    {%endblock methods%}

    {%block filters%}
        firstNameMenu: ((value) => {
            if (!value) return ''
            return value.toString().charAt(0).toUpperCase()
        }),
        lastNameMenu: ((value) => {
            if (!value) return ''
            return value.toString().slice(1)
        }),
        formatPrice: ((value) => {
            let val = (value/1).toFixed(2)
            return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")
        }),
        FormatTDate: ((value) => {
            moment.locale('es');
            return String(moment(value).format('DD/MM/YYYY h:mm:ss'))
        }),
        defaultV: ((value, defaultV) => {
            if(value)return value
            return defaultV
        }),
    {%endblock filters%}

    {%block watch%}
        'Client.name': function (newData, oldData) {
            if(newData){
                Ax('get', '{%url 'SV:Sellpoint__ApiView' 'SV' 'set_sellpoint' 'Sellpoint'%}?api=getClients&query='+newData)
                .then(function(json){
                    self.Clients = json.data.clients
                }).catch((error) => {
                    console.log(error)
                });
            }else{
                self.resetOrder()
            }
        }
    {%endblock watch%}

    {%block vuecomponents%}
        {%include 'components/date-picker.js'%}
    {%endblock vuecomponents%}
</script>